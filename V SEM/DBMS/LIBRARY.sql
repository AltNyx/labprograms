-- TABLES

CREATE TABLE PUBLISHER(
NAME VARCHAR(20) PRIMARY KEY,
ADDRESS VARCHAR(30) NOT NULL,
PHONE INT);


CREATE TABLE BOOK(
BOOK_ID INT PRIMARY KEY,
TITLE VARCHAR(20),
PUB_NAME VARCHAR(20),
PUB_YEAR INT,
FOREIGN KEY(PUB_NAME) REFERENCES PUBLISHER(NAME) ON DELETE CASCADE);



CREATE TABLE BOOK_AUTHORS(
BOOK_ID INT,
NAME VARCHAR(30),
FOREIGN KEY(BOOK_ID) REFERENCES BOOK(BOOK_ID) ON DELETE CASCADE,
PRIMARY KEY(BOOK_ID, NAME));


CREATE TABLE LIBRARY_BRANCH(
BRANCH_ID INT PRIMARY KEY,
BRANCH_NAME VARCHAR(20),
ADDRESS VARCHAR(50));


CREATE TABLE BOOK_COPIES(
BOOK_ID INT,
BRANCH_ID INT,
NUM_COPIES INT,
PRIMARY KEY(BOOK_ID, BRANCH_ID),
FOREIGN KEY(BOOK_ID) REFERENCES BOOK(BOOK_ID) ON DELETE CASCADE,
FOREIGN KEY(BRANCH_ID) REFERENCES LIBRARY_BRANCH(BRANCH_ID) ON DELETE CASCADE);


CREATE TABLE BORROWER(
CARD_NO INT,
NAME VARCHAR(20),
PRIMARY KEY(CARD_NO));


CREATE TABLE BOOK_LENDING(
BOOK_ID INT,
BRANCH_ID INT,
CARD_NO INT,
DATEOUT DATE,
DUEDATE DATE,
FOREIGN KEY(BOOK_ID) REFERENCES BOOK(BOOK_ID) ON DELETE CASCADE,
FOREIGN KEY(BRANCH_ID) REFERENCES LIBRARY_BRANCH(BRANCH_ID) ON DELETE CASCADE,
FOREIGN KEY(CARD_NO) REFERENCES BORROWER(CARD_NO) ON DELETE CASCADE,
PRIMARY KEY(BOOK_ID, BRANCH_ID, CARD_NO));


-- INSERTING

INSERT INTO PUBLISHER VALUES("JAICO","BANGLORE",77002299);
INSERT INTO PUBLISHER VALUES("WESTLAND","PUNE",770022549);
INSERT INTO PUBLISHER VALUES("PENGUIN ","MUMBAI",77002199);
INSERT INTO PUBLISHER VALUES("ROLI","SANAA",77002229);
INSERT INTO PUBLISHER VALUES("RUPA","THAMAR",77202299);
INSERT INTO PUBLISHER VALUES("HACHETTE","ADEN",77002299);
INSERT INTO PUBLISHER VALUES("AYAAN","US",77002299);


INSERT INTO BOOK VALUES (1,"LEARN HTML","JAICO",2012);
INSERT INTO BOOK VALUES (2,"LEARN JAVA","JAICO",2005);
INSERT INTO BOOK VALUES (3,"LEARN PYTHON","JAICO",2016);
INSERT INTO BOOK VALUES (4,"LEARN ANYTHIN","JAICO",2010);
INSERT INTO BOOK VALUES (5,"C#","JAICO",2011);
INSERT INTO BOOK VALUES (6,"LINUX","JAICO",2017);


INSERT INTO BOOK_AUTHORS VALUES (1,"DEEPAK T");
INSERT INTO BOOK_AUTHORS VALUES (2,"GIRISH");
INSERT INTO BOOK_AUTHORS VALUES (3,"GANESH");
INSERT INTO BOOK_AUTHORS VALUES (4,"KARTIK KUMAR");
INSERT INTO BOOK_AUTHORS VALUES (5,"KISHORE");
INSERT INTO BOOK_AUTHORS VALUES (6,"MANISH");



INSERT INTO LIBRARY_BRANCH VALUES (1,"CMRIT","BANGLORE");
INSERT INTO LIBRARY_BRANCH VALUES (2,"CMRIMS","GERMANY");
INSERT INTO LIBRARY_BRANCH VALUES (3,"CMRPU","US");
INSERT INTO LIBRARY_BRANCH VALUES (4,"ITPL","MYSORE");
INSERT INTO LIBRARY_BRANCH VALUES (5,"NPS","MUMBAI");



INSERT INTO BORROWER VALUES (1,"PRANAV");
INSERT INTO BORROWER VALUES (2,"ANISHA");
INSERT INTO BORROWER VALUES (3,"KIRAN ");
INSERT INTO BORROWER VALUES (4,"DILIP");
INSERT INTO BORROWER VALUES (5,"SAMMER");



INSERT INTO BOOK_COPIES VALUES (1,1,2);
INSERT INTO BOOK_COPIES VALUES (2,2,2);
INSERT INTO BOOK_COPIES VALUES (3,3,2);
INSERT INTO BOOK_COPIES VALUES (4,4,2);
INSERT INTO BOOK_COPIES VALUES (5,5,2);
INSERT INTO BOOK_COPIES VALUES (6,1,2);
INSERT INTO BOOK_COPIES VALUES (1,3,2);
INSERT INTO BOOK_COPIES VALUES (1,5,2);
INSERT INTO BOOK_COPIES VALUES (5,1,2);
INSERT INTO BOOK_COPIES VALUES (4,1,2);

     
INSERT INTO BOOK_LENDING VALUES (1,1,1,"2017-08-01","2017-08-10");
INSERT INTO BOOK_LENDING VALUES (2,1,1,"2017-08-01","2017-08-10");
INSERT INTO BOOK_LENDING VALUES (3,1,1,"2017-08-01","2017-02-10");
INSERT INTO BOOK_LENDING VALUES (4,1,1,"2017-08-01","2017-06-10");
INSERT INTO BOOK_LENDING VALUES (3,1,2,"2017-01-01","2017-08-10");
INSERT INTO BOOK_LENDING VALUES (1,1,3,"2017-01-01","2017-08-10");
INSERT INTO BOOK_LENDING VALUES (1,2,1,"2017-04-01","2017-04-10");
INSERT INTO BOOK_LENDING VALUES (3,1,4,"2017-08-01","2017-08-10");
INSERT INTO BOOK_LENDING VALUES (3,2,3,"2017-04-01","2017-03-10");
INSERT INTO BOOK_LENDING VALUES (4,2,3,"2017-05-01","2017-08-10");
INSERT INTO BOOK_LENDING VALUES (5,2,3,"2017-01-01","2017-05-10");
INSERT INTO BOOK_LENDING VALUES (6,1,4,"2017-01-01","2017-07-10");
INSERT INTO BOOK_LENDING VALUES (4,1,4,"2017-03-01","2017-08-10");
INSERT INTO BOOK_LENDING VALUES (5,1,4,"2017-04-01","2017-08-10");
INSERT INTO BOOK_LENDING VALUES (6,2,2,"2017-04-01","2017-08-10");
INSERT INTO BOOK_LENDING VALUES (4,4,2,"2017-01-01","2017-08-10");
INSERT INTO BOOK_LENDING VALUES (2,1,2,"2017-02-01","2017-08-10");
INSERT INTO BOOK_LENDING VALUES (5,1,2,"2017-03-01","2017-08-10");
INSERT INTO BOOK_LENDING VALUES (6,3,2,"2017-01-01","2017-08-10");
INSERT INTO BOOK_LENDING VALUES (2,4,4,"2017-04-01","2017-08-10");
INSERT INTO BOOK_LENDING VALUES (6,3,4,"2017-01-01","2017-08-10");

-- QUERIES

--1
SELECT B.BOOK_ID, B.TITLE, B.PUB_NAME, BA.NAME AS AUTHOR, BC.NUM_COPIES, LB.BRANCH_ID, LB.BRANCH_NAME
FROM BOOK B, BOOK_AUTHORS BA, BOOK_COPIES BC, LIBRARY_BRANCH LB
WHERE B.BOOK_ID=BA.BOOK_ID
AND B.BOOK_ID=BC.BOOK_ID
AND LB.BRANCH_ID=BC.BRANCH_ID;


--2
SELECT B.CARD_NO, B.NAME, COUNT(*)
FROM BORROWER B, BOOK_LENDING BL
WHERE DATEOUT BETWEEN '2017-01-01' AND '2017-06-30'
AND B.CARD_NO=BL.CARD_NO
GROUP BY B.CARD_NO
HAVING COUNT(*)>3;


--3
DELETE FROM BOOK
WHERE BOOK_ID=3;


--4

-- CREATING A NEW TABLE WITH PARTITION
CREATE TABLE BOOK1
(
BOOKID INT NOT NULL,
TITLE VARCHAR(20),
NAME VARCHAR(20) ,
PUBYEAR INT,
PRIMARY KEY(BOOKID,PUBYEAR)
) PARTITION BY RANGE (PUBYEAR) (
  PARTITION P0 VALUES LESS THAN (1991),
  PARTITION P1 VALUES LESS THAN (1995),
  PARTITION P2 VALUES LESS THAN (1999),
  PARTITION P3 VALUES LESS THAN (2003),
  PARTITION P4 VALUES LESS THAN (2007),
  PARTITION P5 VALUES LESS THAN (2010),
  PARTITION P6 VALUES LESS THAN (2015),
  PARTITION P7 VALUES LESS THAN (2020)
);

-- INSERTING VALUES TO THE NEW TABLE
INSERT INTO BOOK1 VALUES (1,"LEARN HTML","JAICO",2012);
INSERT INTO BOOK1 VALUES (2,"LEARN JAVA","JAICO",2005);
INSERT INTO BOOK1 VALUES (3,"LEARN PYTHON","JAICO",2016);
INSERT INTO BOOK1 VALUES (4,"LEARN ANYTHIN","JAICO",2010);
INSERT INTO BOOK1 VALUES (5,"C#","JAICO",2011);
INSERT INTO BOOK1 VALUES (6,"LINUX","JAICO",2017);

-- THEN QUERYING BY PARTITION
SELECT * FROM BOOK1 PARTITION(P7);


-- CREATE VIEW V_PUBLICATION AS
-- SELECT PUB_YEAR
-- FROM BOOK;

-- SELECT * FROM V_PUBLICATION;


--5
CREATE VIEW V_NUM_COPIES AS
SELECT B.BOOK_ID, B.TITLE, SUM(BC.NUM_COPIES) AS NUM_COPIES
FROM BOOK B, BOOK_COPIES BC
WHERE B.BOOK_ID=BC.BOOK_ID
GROUP BY B.BOOK_ID;

SELECT * FROM V_NUM_COPIES;